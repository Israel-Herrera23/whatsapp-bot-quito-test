require('dotenv').config();
const express = require('express');
const axios = require('axios');

const app = express();
app.use(express.json());

// ====== CONFIGURACIÃ“N ======
const TOKEN = process.env.WHATSAPP_TOKEN;
const PHONE_ID = process.env.PHONE_ID;
const VERIFY_TOKEN = process.env.VERIFY_TOKEN;

// Horario de atenciÃ³n - QUITO, ECUADOR
const horario = {
  zona: 'America/Guayaquil',
  inicio: { hora: 8, minuto: 30 },     // Lunes a viernes 08:30
  fin: { hora: 18, minuto: 30 },       // hasta 18:30
  sabado: { inicio: 9, fin: 14 },      // SÃ¡bado 09:00 â€“ 14:00
};

// Mensajes personalizados (cÃ¡mbialos cuando quieras)
const respuestas = {
  fueraHorario: "Â¡Hola! ðŸ‘‹\n\nGracias por tu mensaje.\nEn este momento estamos fuera de nuestro horario de atenciÃ³n ðŸ˜´\n\nTe responderemos lo mÃ¡s pronto posible cuando regresemos.\n\nðŸ•™ Nuestro horario es:\nLunes a viernes: 08:30 â€“ 18:30\nSÃ¡bado: 09:00 â€“ 14:00\nDomingo: cerrado\n\nÂ¡Que tengas un excelente dÃ­a! ðŸŒŸ",
  
  saludo: "Â¡Hola! ðŸ‘‹\nÂ¡QuÃ© gusto saludarte!\nÂ¿En quÃ© te puedo ayudar hoy?",
  precio: "Nuestros precios inician desde $25. Â¿QuÃ© producto o servicio te interesa exactamente?",
  horario: "ðŸ•™ Te atendemos en:\nLunes a viernes: 08:30 â€“ 18:30\nSÃ¡bado: 09:00 â€“ 14:00\nÂ¡AquÃ­ estamos para ayudarte!",
  direccion: "Estamos ubicados en Av. Amazonas y Naciones Unidas, Quito\nðŸ“ https://maps.app.goo.gl/EjemploLinkMapsCambialo",
  default: "Gracias por escribirnos ðŸ™Œ\nEn un momento te atiende uno de nuestros asesores. Â¡Un poquito de paciencia por favor!"
};

// ====== Â¿ESTÃ DENTRO DEL HORARIO? ======
function estaEnHorario() {
  const ahora = new Date().toLocaleString("en-US", { timeZone: horario.zona });
  const fecha = new Date(ahora);
  const dia = fecha.getDay();
  const hora = fecha.getHours();
  const minuto = fecha.getMinutes();
  const horaActual = hora + minuto / 60;

  if (dia === 0) return false;
  if (dia === 6) {
    return horaActual >= horario.sabado.inicio && horaActual < horario.sabado.fin;
  }
  return horaActual >= (horario.inicio.hora + horario.inicio.minuto / 60) &&
         horaActual < (horario.fin.hora + horario.fin.minuto / 60);
}

// ====== ENVIAR MENSAJE ======
async function enviarMensaje(to, texto) {
  try {
    await axios.post(
      `https://graph.facebook.com/v20.0/${PHONE_ID}/messages`,
      {
        messaging_product: "whatsapp",
        to: to,
        type: "text",
        text: { body: texto }
      },
      { headers: { Authorization: `Bearer ${TOKEN}` } }
    );
  } catch (error) {
    console.error("Error enviando:", error.response?.data || error.message);
  }
}

// ====== WEBHOOKS ======
app.get('/webhook', (req, res) => {
  if (req.query['hub.mode'] === 'subscribe' && req.query['hub.verify_token'] === VERIFY_TOKEN) {
    res.send(req.query['hub.challenge']);
  } else {
    res.sendStatus(403);
  }
});

app.post('/webhook', async (req, res) => {
  const body = req.body;

  if (body.object && body.entry?.[0]?.changes?.[0]?.value?.messages?.[0]) {
    const msg = body.entry[0].changes[0].value.messages[0];
    const from = msg.from;
    const texto = (msg.text?.body || '').toLowerCase().trim();

    let respuesta = respuestas.default;

    if (!estaEnHorario()) {
      respuesta = respuestas.fueraHorario;
    } else {
      if (/hola|buenos dÃ­as|buenas tardes|buenas noches|hey|saludos|quÃ© tal/.test(texto)) {
        respuesta = respuestas.saludo;
      } else if (/precio|cuÃ¡nto cuesta|costo|valor|tarifa/.test(texto)) {
        respuesta = respuestas.precio;
      } else if (/horario|hora|atienden|abren/.test(texto)) {
        respuesta = respuestas.horario;
      } else if (/direcciÃ³n|ubicaciÃ³n|dÃ³nde estÃ¡n|dÃ³nde queda|address/.test(texto)) {
        respuesta = respuestas.direccion;
      }
    }

    await enviarMensaje(from, respuesta);
  }
  res.sendStatus(200);
});

app.get('/', (req, res) => res.send('Bot WhatsApp Quito ECUADOR activo 24/7'));

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`Bot corriendo en puerto ${PORT}`));
{
  "name": "whatsapp-bot-quito-ecuador",
  "version": "1.0.0",
  "description": "Bot WhatsApp gratuito con horario de Quito - Ecuador",
  "main": "index.js",
  "scripts": {
    "start": "node index.js"
  },
  "keywords": ["whatsapp", "bot", "ecuador", "quito", "cloud-api"],
  "author": "Tu Nombre",
  "license": "MIT",
  "dependencies": {
    "axios": "^1.7.7",
    "dotenv": "^16.4.5",
    "express": "^4.21.0"
  }
}
WHATSAPP_TOKEN=tu_token_permanente_aqui
PHONE_ID=123456789012345
VERIFY_TOKEN=MiClaveSuperSecreta2025
# WhatsApp Bot Quito - Ecuador

Bot 100% GRATUITO con respuestas automÃ¡ticas y mensaje "fuera de horario" perfecto para negocios en Quito.

### Horario configurado
- Lunes a viernes â†’ 08:30 â€“ 18:30  
- SÃ¡bado â†’ 09:00 â€“ 14:00  
- Domingo â†’ cerrado (mensaje automÃ¡tico)

### CÃ³mo ponerlo en marcha (5 minutos)

1. Crea la app en https://developers.facebook.com/apps
2. Activa WhatsApp y genera tu token permanente
3. Despliega gratis en Render.com (conecta este repositorio)
4. Pega la URL + `/webhook` en Meta â†’ Webhook
5. Â¡Listo! Ya responde solo

Costo: $0 para siempre  
Hosting: Render.com (plan gratis 24/7)  
API: WhatsApp Cloud API oficial (gratis)

Â¡Funciona perfecto en 2025!
